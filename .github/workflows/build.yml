name: Build and Package fpdb-3, pypoker-eval, and poker-eval

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
          git submodule update --init --recursive
          pip install -r fpdb-3/requirements.txt


      - name: Rendre le script exécutable
        run: chmod +x ./build.sh
        shell: bash

      - name: Build fpdb-3
        run: bash ./build.sh
        shell: bash

      - name: Archive build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts-windows
          path: fpdb-3/dist/*

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.11
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake
          sudo apt-get install -y libxcb1 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-shape0 libxcb-xinerama0 libxkbcommon-x11-0 libxcb-xfixes0 fuse libfuse2
          sudo modprobe fuse
          sudo groupadd fuse
          sudo usermod -a -G fuse $USER
          git submodule update --init --recursive
          python -m pip install --upgrade pip setuptools wheel
          pip install -r fpdb-3/requirements-linux.txt


      - name: Rendre le script exécutable
        run: chmod +x ./build.sh
        shell: bash
      - name: Rendre le script exécutable
        run: chmod +x ./build_fpdb-linux.sh
        shell: bash

      - name: Build fpdb-3
        run: bash ./build.sh
      - name: Archive build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts-linux
          path: fpdb-3/dist/*

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.11
      - name: Install dependencies
        run: |
          brew install cmake
          git submodule update --init --recursive
          python -m pip install --upgrade pip setuptools wheel
          brew info pyqt@5
          brew install pyqt@5
          python -m pip install sip==6.6.2 
          pip install -r fpdb-3/requirements_macos.txt
        


      - name: Rendre le script exécutable
        run: chmod +x ./build.sh
        shell: bash
      - name: Rendre le script exécutable
        run: chmod +x ./fpdb-3/pypoker-eval/build.sh
        shell: bash
      - name: Rendre le script exécutable
        run: chmod +x ./build_fpdb-osx.sh
        shell: bash

      - name: Build fpdb-3
        run: bash ./build.sh
      - name: Archive build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts-macos
          path: fpdb-3/dist/*

  build-macos-arm:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.11
      - name: Install dependencies
        run: |
          brew install cmake
          git submodule update --init --recursive
          python -m pip install --upgrade pip setuptools wheel
          brew info pyqt@5
          brew install pyqt@5
          python -m pip install sip==6.6.2 
          pip install -r fpdb-3/requirements_macos.txt




      - name: Rendre le script exécutable
        run: chmod +x ./build.sh
        shell: bash
      - name: Rendre le script exécutable
        run: chmod +x ./fpdb-3/pypoker-eval/build.sh
        shell: bash
      - name: Rendre le script exécutable
        run: chmod +x ./build_fpdb-osx.sh
        shell: bash

      - name: Build fpdb-3
        run: |
          export ARCHFLAGS="-arch arm64"
          bash ./build.sh
      - name: Archive build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts-macos-arm
          path: fpdb-3/dist/*

  build-macos-test:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          submodules: 'recursive'

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          brew install cmake
          pip install -r fpdb-3/requirements_macos.txt

      - name: Debug Python environment
        run: |
          which python3
          python3 --version
          echo "PYTHON_PATH: $pythonLocation/bin/python3"
          echo "PYTHON_INCLUDE_DIR: $pythonLocation/include/python3.11"
          echo "PYTHON_LIBRARY: $pythonLocation/lib/libpython3.11.dylib"
          ls -l $pythonLocation/bin
          ls -l $pythonLocation/include
          ls -l $pythonLocation/lib
          cmake --version

      - name: Build poker-eval
        run: |
          cd fpdb-3/pypoker-eval/poker-eval
          mkdir -p build && cd build
          cmake ..
          make
          cd ../../..

      - name: Build pypoker-eval
        run: |
          cd fpdb-3/pypoker-eval
          mkdir -p build && cd build
          cmake -DPython3_EXECUTABLE=$pythonLocation/bin/python3 \
                -DPython3_INCLUDE_DIR=$pythonLocation/include/python3.11 \
                -DPython3_LIBRARY=$pythonLocation/lib/libpython3.11.dylib \
                ..
          make VERBOSE=1
          echo "Contents of build directory:"
          ls -R
          cd ../..
      
      - name: Copy pypokereval.so
        run: |
          find fpdb-3/pypoker-eval/build -name "pypokereval*.so" -exec cp {} fpdb-3/pypoker-eval/_pokereval_3_11.so \;
      
      - name: Verify copy
        run: |
          ls -l fpdb-3/pypoker-eval/_pokereval_3_11.so
          cp fpdb-3/pypoker-eval/_pokereval_3_11.so fpdb-3/_pokereval_3_11.so
          cp fpdb-3/pypoker-eval/pokereval.py fpdb-3/pokereval.py

      - name: Rendre le script exécutable
        run: chmod +x ./build_fpdb-osx.sh
        shell: bash

      - name: Build fpdb-3
        run: |
          ./build_fpdb-osx.sh

      - name: Archive build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts-macos
          path: fpdb-3/dist/*